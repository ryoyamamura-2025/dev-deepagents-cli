\# ファイルシステム構造設計



\## 概要



AI agentが参照・作成するファイルを管理するための3層構造。



\## ディレクトリ構成



```

workspace/

└── {user\_email}/

&nbsp;   ├── flow/       # Flow: スレッド単位の一時作業

&nbsp;   ├── stock/      # Stock: スレッド横断で使う資料

&nbsp;   └── project/    # Project: 継続プロジェクト

```



\## 各層の役割



\### Flow

\- \*\*用途\*\*: AI agentの成果物、ユーザーが一時的に使いたいファイル

\- \*\*例\*\*: 会議議事録、1回限りの分析結果、レポート

\- \*\*ライフサイクル\*\*: スレッド単位（削除可能）

\- \*\*スレッドフィルタ\*\*: UIで現在のスレッドIDでフィルタして表示



\### Stock

\- \*\*用途\*\*: ユーザーがスレッドを越えて参照したいもの

\- \*\*例\*\*: テンプレート、ナレッジベース、コーディング規約、参考資料

\- \*\*ライフサイクル\*\*: 永続的（ユーザー管理）



\### Project

\- \*\*用途\*\*: 一定期間継続して使うプロジェクト

\- \*\*例\*\*: Webアプリ開発、研究プロジェクト

\- \*\*ライフサイクル\*\*: プロジェクト単位（長期）



\## ユーザー識別



Cloud Runでデプロイした際、ルートパスにアクセスしたユーザーのメールアドレスを取得：



```python

email = request.headers.get('X-Goog-Authenticated-User-Email')

user\_dir = f"workspace/{email}"

```



\## GCS連携



\### セッション開始時

```python

\# GCS → Cloud Runローカルにダウンロード

download\_from\_gcs(f"gs://bucket/{user\_dir}/", local\_path)

```



\### セッション終了時

```python

\# ローカル → GCSにアップロード

upload\_to\_gcs(local\_path, f"gs://bucket/{user\_dir}/")

```



\### 同期戦略



| ディレクトリ | 同期タイミング | 保持期間 | ダウンロード範囲 |

|------------|--------------|---------|---------------|

| flow/ | セッション終了時 | 30日（自動削除） | 当該スレッドのみ |

| stock/ | リアルタイム | 永続 | 全体 |

| project/ | リアルタイム | 永続 | プロジェクト選択時 |



\## Skills \& Memory の整理



\### ユーザーメモリ

\- 場所: `{user\_dir}/.deepagents/agent.md`

\- 用途: ユーザーの好み、全プロジェクト共通の指示



\### プロジェクトメモリ

\- 場所: `{user\_dir}/project/{project\_name}/.deepagents/agent.md`

\- 用途: プロジェクト固有の指示、アーキテクチャ、慣習



\### Skills

\- ユーザースキル: `{user\_dir}/.deepagents/skills/`

\- プロジェクトスキル: `{user\_dir}/project/{project\_name}/.deepagents/skills/`



\## 実装優先順位



1\. \*\*Phase 1\*\*: 基本ディレクトリ構造の実装

&nbsp;  - 3層ディレクトリの作成

&nbsp;  - ユーザーパス解決ロジック



2\. \*\*Phase 2\*\*: GCS連携

&nbsp;  - GCSクライアント実装

&nbsp;  - セッション管理（開始/終了フック）

&nbsp;  - ユーザー認証連携



3\. \*\*Phase 3\*\*: UI最適化

&nbsp;  - ユーザーごとのディレクトリ表示

&nbsp;  - flowのスレッドフィルタ



4\. \*\*Phase 4\*\*: Skills \& Memory の階層化

