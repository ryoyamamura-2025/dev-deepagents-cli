#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Cloud Run ã¸ã®ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
ç’°å¢ƒå¤‰æ•°ã§ã®æŒ‡å®šã‚’åŸºæœ¬ã¨ã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ä¸Šæ›¸ãå¯èƒ½ã§ã™ã€‚

ä¸»è¦ç’°å¢ƒå¤‰æ•° / ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  PROJECT_ID / --project|-p        å¿…é ˆã€‚GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID
  REGION / --region|-r             ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: us-central1
  REPO / --repo                    Artifact Registry ã®ãƒªãƒã‚¸ãƒˆãƒªå (docker)
  SERVICE_NAME / --service|-s      Cloud Run ã‚µãƒ¼ãƒ“ã‚¹å
  IMAGE_NAME / --image             ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸å
  TAG / --tag                      ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: dev
  MEMORY / --memory                Cloud Run ãƒ¡ãƒ¢ãƒªã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 4Gi
  CPU / --cpu                      Cloud Run CPUã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1
  TIMEOUT / --timeout              ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç§’ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 300
  PORT / --port                    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 8080
  ENV_FILE / --env-file            --env-vars-file ã«æ¸¡ã™ãƒ•ã‚¡ã‚¤ãƒ« (å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é©ç”¨)
  ALLOW_UNAUTH / --allow-unauth    true ã§ --allow-unauthenticated ã‚’ä»˜ä¸
  BUILD_CONTEXT / --context        docker build ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: .
  DESCRIPTION / --description      Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªèª¬æ˜
  --help                           ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
EOF
}

PROJECT_ID="${PROJECT_ID:-xxxxxxxxxxxxxxxxxxxx}"
REGION="${REGION:-us-central1}"
REPO="${REPO:-xxxxxxxxxxxxxxxxxxxx}"
SERVICE_NAME="${SERVICE_NAME:-xxxxxxxxxxxxxxxxxxxx}"
IMAGE_NAME="${IMAGE_NAME:-xxxxxxxxxxxxxxxxxxxx}"
TAG="${TAG:-dev}"
MEMORY="${MEMORY:-4Gi}"
CPU="${CPU:-1}"
TIMEOUT="${TIMEOUT:-300}"
PORT="${PORT:-8080}"
ENV_FILE="${ENV_FILE:-.env.yaml}"
ALLOW_UNAUTH="${ALLOW_UNAUTH:-false}"
BUILD_CONTEXT="${BUILD_CONTEXT:-.}"
DESCRIPTION="${DESCRIPTION:-Docker images for Cloud Run}"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --project|-p) PROJECT_ID="$2"; shift 2 ;;
    --region|-r) REGION="$2"; shift 2 ;;
    --repo) REPO="$2"; shift 2 ;;
    --service|-s) SERVICE_NAME="$2"; shift 2 ;;
    --image) IMAGE_NAME="$2"; shift 2 ;;
    --tag) TAG="$2"; shift 2 ;;
    --memory) MEMORY="$2"; shift 2 ;;
    --cpu) CPU="$2"; shift 2 ;;
    --timeout) TIMEOUT="$2"; shift 2 ;;
    --port) PORT="$2"; shift 2 ;;
    --env-file) ENV_FILE="$2"; shift 2 ;;
    --allow-unauth|--allow-unauthenticated) ALLOW_UNAUTH="true"; shift ;;
    --context) BUILD_CONTEXT="$2"; shift 2 ;;
    --description) DESCRIPTION="$2"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
  esac
done

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "âŒ $1 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚" >&2
    exit 1
  fi
}

require gcloud
require docker

if [[ -z "$PROJECT_ID" ]]; then
  PROJECT_ID="$(gcloud config get-value core/project 2>/dev/null || true)"
fi

if [[ -z "$PROJECT_ID" ]]; then
  echo "âŒ PROJECT_ID ãŒæœªè¨­å®šã§ã™ã€‚ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ --project ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚" >&2
  usage
  exit 1
fi

ACTIVE_ACCOUNT="$(gcloud auth list --filter=status:ACTIVE --format="value(account)" 2>/dev/null || true)"
if [[ -z "$ACTIVE_ACCOUNT" ]]; then
  echo "âŒ gcloud ã®èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'gcloud auth login' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi

echo "ğŸ”§ Setting gcloud project to ${PROJECT_ID}..."
gcloud config set project "$PROJECT_ID" >/dev/null

REPO_HOST="${REGION}-docker.pkg.dev"
IMAGE_URI="${REPO_HOST}/${PROJECT_ID}/${REPO}/${IMAGE_NAME}:${TAG}"

if ! gcloud artifacts repositories describe "$REPO" --location "$REGION" >/dev/null 2>&1; then
  echo "ğŸ“¦ Creating Artifact Registry repository '${REPO}' in ${REGION}..."
  gcloud artifacts repositories create "$REPO" \
    --repository-format=docker \
    --location="$REGION" \
    --description="$DESCRIPTION"
else
  echo "âœ… Artifact Registry repository '${REPO}' (location: ${REGION}) ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"
fi

echo "ğŸ” Configuring docker auth for ${REPO_HOST}..."
gcloud auth configure-docker "${REPO_HOST}" --quiet

echo "ğŸ”¨ Building image ${IMAGE_URI} ..."
docker build -t "${IMAGE_URI}" "${BUILD_CONTEXT}"

echo "ğŸ“¤ Pushing image to Artifact Registry..."
docker push "${IMAGE_URI}"

DEPLOY_ARGS=(
  --image "${IMAGE_URI}"
  --platform managed
  --project "${PROJECT_ID}"
  --region "${REGION}"
  --port "${PORT}"
  --memory "${MEMORY}"
  --cpu "${CPU}"
  --timeout "${TIMEOUT}"
)

if [[ -f "${ENV_FILE}" ]]; then
  DEPLOY_ARGS+=(--env-vars-file="${ENV_FILE}")
else
  echo "â„¹ï¸ ENV_FILE '${ENV_FILE}' ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚--env-vars-file ã¯æŒ‡å®šã—ã¾ã›ã‚“ã€‚"
fi

if [[ "${ALLOW_UNAUTH}" == "true" ]]; then
  DEPLOY_ARGS+=(--allow-unauthenticated)
else
  DEPLOY_ARGS+=(--no-allow-unauthenticated)
fi

echo "ğŸš€ Deploying Cloud Run service '${SERVICE_NAME}' ..."
gcloud run deploy "${SERVICE_NAME}" "${DEPLOY_ARGS[@]}"

echo "âœ… Deployment complete!"
gcloud run services describe "${SERVICE_NAME}" --region "${REGION}" --format 'value(status.url)'