# Dockerfile.dev - 軽量化版
FROM python:3.13-slim

# uv（高速パッケージマネージャ）を取り込み
COPY --from=ghcr.io/astral-sh/uv:0.8.14 /uv /uvx /bin/

# 必要なパッケージを一括インストール＆クリーンアップ
# --no-install-recommends: 推奨パッケージを除外
# apt-get clean: aptキャッシュをクリーンアップ
# rm -rf /var/lib/apt/lists/*: パッケージリストを削除
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    nodejs \
    npm \
    && npm install -g docx \
    && npm cache clean --force \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

WORKDIR /app

# 依存関係のみをインストール（キャッシュ活用）
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=./backend/pyproject.toml,target=pyproject.toml \
    --mount=type=bind,source=./backend/uv.lock,target=uv.lock \
    uv sync --locked --no-install-project --no-dev

# ソースをコピー
COPY ./backend/pyproject.toml ./backend/uv.lock ./
COPY ./backend ./

# プロジェクト本体を同期
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev

CMD ["bash", "/app/start.sh"]